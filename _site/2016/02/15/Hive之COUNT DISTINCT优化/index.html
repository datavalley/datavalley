<!DOCTYPE html>
<html>

    <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <title>Hive之COUNT DISTINCT优化 - Data Valley</title>
      <meta name="author" content="小z">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" >
      <link rel="canonical" href="http://datavalley.github.io/2016/02/15/Hive%E4%B9%8BCOUNT%20DISTINCT%E4%BC%98%E5%8C%96/">
      <link rel="stylesheet" href="/static/css/bootstrap.min.css" media="all">
      <link rel="stylesheet" href="/static/css/style.css" media="all">
      <link rel="stylesheet" href="/static/css/pygments.css" media="all">
      <link rel="stylesheet" href="/static/css/font-awesome.css" media="all">

      <!-- atom & rss feed -->
      <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Data Valley RSS Feed">
      <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Data Valley ATOM Feed">

      <script type="text/javascript" src="/static/js/jquery.min.js"  charset="utf-8"></script>
      <script type="text/javascript" src="/static/js/sidenav.js" charset="utf-8"></script>
    </head>


  <body>

    <div class="container">

    <!--[if lte IE 9]>
<div class="alert alert-warning">
  <p>Your Internet Explorer is not supported. Please upgrade your Internet Explorer to version 9+, or use latest <a href="http://www.google.com/chrome/" target="_blank" class="alert-link">Google chrome</a>、<a href="http://www.mozilla.org/firefox/" target="_blank" class="alert-link">Mozilla Firefox</a>.</p>
  <p>If you are using IE 9 or later, make sure you <a href="http://windows.microsoft.com/en-us/internet-explorer/use-compatibility-view#ie=ie-8" target="_blank" class="alert-link">turn off "Compatibility view"</a>.</p>
</div>
<![endif]-->
<header class="header">
  <div class="title"><a title="Data Valley" href="/">Data Valley</a></div>
  <ul class="nav navbar-nav navbar-right visible-lg visible-md">
    <li>
    <form id="search-form" class="form-group has-success visible-lg" role="form">
      <input type="text" class="form-control input-sm" placeholder="Search" id="query" style="width: 160px;">
    </form>
    </li>
    <li><a href="/archive.html" title="Archive"><span class='fa fa-archive fa-2x'></span></a></li>
    <li><a href="/categories.html" title="Categories"><span class='fa fa-navicon fa-2x'></span></a></li>
    <li><a href="/tags.html" title="Tags"><span class='fa fa-tags fa-2x'></span></a></li>
    <li><a href="/about.html" title="About"><span class='fa fa-user fa-2x'></span></a></li>
    
    <li><a href="https://github.com/datavalley/datavalley.github.io" target="_blank" title="Github"><span class='fa fa-github fa-2x'></span></a></li>
    
    
    
    
    

    <li><a href="/rss.xml" target="_blank" title="RSS"><span class='fa fa-rss fa-2x'></span></a></li>
  </ul>
</header>


      <div class="wrapper">
        <div class="row">
          <div id="search-loader" style="display:none;text-align:center">
            <img src="/static/images/loading.gif">
          </div>
          <div class="col-md-12">
            <div id="content"></div>
            <article class="news-item">
                <h1  class="news-item"> Hive之COUNT DISTINCT优化  
                  <time class="small">2016.02.15</time>
                </h1>

                <div>
                <p>COUNT(DISTINCT xxx)在hive中很容易造成数据倾斜。针对这一情况，网上已有很多优化方法，这里不再赘述。</p>

<p>但有时，“数据倾斜”又几乎是必然的。我们来举个例子：</p>

<p>假设表detail_sdk_session中记录了访问某网站M的客户端会话信息，即：如果用户A打开app客户端，则会产生一条会话信息记录在该表中，该表的粒度为“一次”会话，其中每次会话都记录了用户的唯一标示uuid，uuid是一个很长的字符串，假定其长度为64位。现在的需求是：<strong>每天统计当月的活用用户数</strong>——“月活跃用户数”（当月访问过app就为活跃用户）。我们以2016年1月为例进行说明，now表示当前日期。</p>

<h2 id="最简单的方法">最简单的方法</h2>

<p>这个问题逻辑上很简单，SQL也很容易写出来，例如：</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">SELECT</span>
  <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">uuid</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">detail_sdk_session</span> <span class="n">t</span>
<span class="k">WHERE</span> <span class="n">t</span><span class="p">.</span><span class="nb">date</span> <span class="o">&gt;=</span> <span class="s1">&#39;2016-01-01&#39;</span> <span class="k">AND</span> <span class="n">t</span><span class="p">.</span><span class="nb">date</span> <span class="o">&lt;=</span> <span class="n">now</span>
</code></pre></div>
<p>上述SQL代码中，now表示当天的日期。很容易想到，越接近月末，上面的统计的数据量就会越大。更重要的是，在这种情况下，“数据倾斜”是必然的，因为只有一个reducer在进行COUNT(DISTINCT uuid)的计算，<strong>所有的数据都流向唯一的一个reducer</strong>，不倾斜才怪。</p>

<h2 id="另一种的方法">另一种的方法</h2>

<p>其实，在COUNT(DISTINCT xxx)的时候，我们可以采用“分治”的思想来解决。对于上面的例子，首先我们按照uuid的前n位进行GROUP BY，并做COUNT(DISTINCT )操作，然后再对所有的COUNT(DISTINCT)结果进行求和。</p>

<p>我们先把SQL写出来，然后再做分析。</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="c1">-- 外层SELECT求和</span>
<span class="k">SELECT</span>
  <span class="k">SUM</span><span class="p">(</span><span class="n">mau_part</span><span class="p">)</span> <span class="n">mau</span>
<span class="k">FROM</span>
<span class="p">(</span>
  <span class="c1">-- 内层SELECT分别进行COUNT(DISTINCT)计算</span>
  <span class="k">SELECT</span>
    <span class="n">substr</span><span class="p">(</span><span class="n">uuid</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="n">uuid_part</span><span class="p">,</span>
    <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">substr</span><span class="p">(</span><span class="n">uuid</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="k">AS</span> <span class="n">mau_part</span>
  <span class="k">FROM</span> <span class="n">detail_sdk_session</span>
  <span class="k">WHERE</span> <span class="n">partition_date</span> <span class="o">&gt;=</span> <span class="s1">&#39;2016-01-01&#39;</span> <span class="k">AND</span> <span class="n">partition_date</span> <span class="o">&lt;=</span> <span class="n">now</span>
  <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">substr</span><span class="p">(</span><span class="n">uuid</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="p">)</span> <span class="n">t</span><span class="p">;</span>
</code></pre></div>
<p>上述SQL中，内层SELECT根据uuid的前3位进行GROUP BY，并计算相应的活跃用户数COUNT(DISTINCT)，外层SELECT求和，得到最终的月活跃用户数。</p>

<p>这种方法的好处在于，<strong>在不同的reducer各自进行COUNT(DISTINCT)计算</strong>，充分发挥hadoop的优势，然后进行求和。</p>

<p>注意，上面SQL中，n设为3，不应过大。</p>

<p>为什么n不应该太大呢？</p>

<p>我们假定uuid是由字母和数字组成的：大写字母、小写字母和数字，字符总数为26+26+10=52。</p>

<p>理论上，内层SELECT进行GROUP BY时，会有 52<sup>n</sup> 个分组，外层SELECT就会进行 52<sup>n</sup> 次求和。所以n不宜过大。</p>

<p>当然，如果数据量十分巨大，n必须充分大，才能保证内层SELECT中的COUNT(DISTINCT)能够计算出来，此时可以再嵌套一层SELECT，这里不再赘述。</p>

                </div>


                <div id="pay" style="text-align:center;">
                  ----EOF-----
                  <br>
                  
                </div>

                <p class="meta">
                	
                      Categories:
                	    
                    	<a class="btn btn-default btn-xs" href="/categories.html#hive">hive</a>
                    
                	

                	
                      Tags:
                	    
                    	<a class="btn btn-default btn-xs" href="/tags.html#hive COUNT DISTINCT">hive COUNT DISTINCT</a>
                    
                	
                </p>
          	</article>

          	<ul class="pager">
          	  
          	  <li class="previous"><a class="btn btn-xs" href="/2015/10/26/Hive%E4%B9%8Bmac%E7%8E%AF%E5%A2%83%E4%B8%AD%E7%9A%84Java%E8%B7%AF%E5%BE%84%E9%97%AE%E9%A2%98" title="Hive之mac环境中的Java路径问题">&larr; Prev</a></li>
          	  
          	  
          	  <li class="next disabled"><a class="btn btn-xs" href="#">Next &rarr;</a></li>
          	  
          	</ul>

            <!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="/2016/02/15/Hive之COUNT DISTINCT优化" data-title="Hive之COUNT DISTINCT优化" data-url="/2016/02/15/Hive%E4%B9%8BCOUNT%20DISTINCT%E4%BC%98%E5%8C%96"></div>
<!-- 多说评论框 end -->


          </div>

        </div>
      </div>

      <footer class="footer text-center">
        <p>&copy; 2009-2016 <a href="/" target="_blank" title="">小z</a> CC BY-NC-SA 3.0. <a href="https://github.com/javachen/javachen-blog-theme" target="_blank" title="https://github.com/javachen/javachen-blog-theme">Theme</a> build with <a href="//jekyllrb.com/" target="_blank" title="Transform your plain text into static websites and blogs.">Jekyll</a>.
      	            
            
        </p>
        <div id="toTop" style="display: block;">  <a href="#">▲</a><a href="#footer">▼</a>  </div>
      </footer>

      <script type="text/javascript" src="/static/js/jquery.min.js"></script>
      <script type="text/javascript" src="/static/js/bootstrap.min.js"></script>
      <script type="text/javascript" src="/static/js/core.js"></script>
      
      <!-- duoshuo Begin -->
      <script type="text/javascript">
        var duoshuoQuery = {short_name:"datavalley"};
        (function() {
          var ds = document.createElement('script');
          ds.type = 'text/javascript';ds.async = true;
          ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
          ds.charset = 'UTF-8';
          (document.getElementsByTagName('head')[0] 
           || document.getElementsByTagName('body')[0]).appendChild(ds);
        })();
      </script>
      <!-- duoshuo End -->
      


    </div>
  </body>
</html>
