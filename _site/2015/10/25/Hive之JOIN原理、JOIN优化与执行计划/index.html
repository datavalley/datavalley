<!DOCTYPE html>
<html>

    <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <title>Hive:JOIN原理、JOIN优化与执行计划 - Data Valley</title>
      <meta name="author" content="小z">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" >
      <link rel="canonical" href="http://datavalley.github.io/2015/10/25/Hive%E4%B9%8BJOIN%E5%8E%9F%E7%90%86%E3%80%81JOIN%E4%BC%98%E5%8C%96%E4%B8%8E%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92/">
      <link rel="stylesheet" href="/static/css/bootstrap.min.css" media="all">
      <link rel="stylesheet" href="/static/css/style.css" media="all">
      <link rel="stylesheet" href="/static/css/pygments.css" media="all">
      <link rel="stylesheet" href="/static/css/font-awesome.css" media="all">

      <!-- atom & rss feed -->
      <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Data Valley RSS Feed">
      <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Data Valley ATOM Feed">
    </head>


  <body>
    <div class="container">
    <!--[if lte IE 9]>
<div class="alert alert-warning">
  <p>Your Internet Explorer is not supported. Please upgrade your Internet Explorer to version 9+, or use latest <a href="http://www.google.com/chrome/" target="_blank" class="alert-link">Google chrome</a>、<a href="http://www.mozilla.org/firefox/" target="_blank" class="alert-link">Mozilla Firefox</a>.</p>
  <p>If you are using IE 9 or later, make sure you <a href="http://windows.microsoft.com/en-us/internet-explorer/use-compatibility-view#ie=ie-8" target="_blank" class="alert-link">turn off "Compatibility view"</a>.</p>
</div>
<![endif]-->
<header class="header">
  <div class="title"><a title="Data Valley" href="/">Data Valley</a></div>
  <ul class="nav navbar-nav navbar-right visible-lg visible-md">
    <li>
    <form id="search-form" class="form-group has-success visible-lg" role="form">
      <input type="text" class="form-control input-sm" placeholder="Search" id="query" style="width: 160px;">
    </form>
    </li>
    <li><a href="/archive.html" title="Archive"><span class='fa fa-archive fa-2x'></span></a></li>
    <li><a href="/categories.html" title="Categories"><span class='fa fa-navicon fa-2x'></span></a></li>
    <li><a href="/tags.html" title="Tags"><span class='fa fa-tags fa-2x'></span></a></li>
    <li><a href="/about.html" title="About"><span class='fa fa-user fa-2x'></span></a></li>
    
    <li><a href="https://github.com/datavalley/datavalley.github.io" target="_blank" title="Github"><span class='fa fa-github fa-2x'></span></a></li>
    
    
    
    
    

    <li><a href="/rss.xml" target="_blank" title="RSS"><span class='fa fa-rss fa-2x'></span></a></li>
  </ul>
</header>


      <div class="wrapper">
        <div class="row">
          <div id="search-loader" style="display:none;text-align:center">
            <img src="/static/images/loading.gif">
          </div>
          <div class="col-md-12">
            <article class="news-item">

                <h1  class="news-item"> Hive:JOIN原理、JOIN优化与执行计划  
                  <time class="small">2015.10.25</time>
                </h1>

                <div>
                <h1 id="1-join的基本原理">1. Join的基本原理</h1>

<p>大家都知道，Hive会将所有的SQL查询转化为Map/Reduce作业运行于Hadoop集群之上。在这里简要介绍Hive将Join转化为Map/Reduce的基本原理（其它查询的原理请参考<a href="http://tech.meituan.com/hive-sql-to-mapreduce.html">这里</a>）。</p>

<p>假定有user和order两张表，分别如下：</p>

<p>user表：</p>

<table><thead>
<tr>
<th>sid</th>
<th>name</th>
</tr>
</thead><tbody>
<tr>
<td>1</td>
<td>apple</td>
</tr>
<tr>
<td>2</td>
<td>orange</td>
</tr>
</tbody></table>

<p>order表：</p>

<table><thead>
<tr>
<th>uid</th>
<th>orderid</th>
</tr>
</thead><tbody>
<tr>
<td>1</td>
<td>1001</td>
</tr>
<tr>
<td>1</td>
<td>1002</td>
</tr>
<tr>
<td>2</td>
<td>1003</td>
</tr>
</tbody></table>

<p>现在想做student和sc两张表上的连接操作：</p>
<div class="highlight"><pre><code class="language-SQL" data-lang="SQL"><span class="k">SELECT</span>
  <span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
  <span class="n">o</span><span class="p">.</span><span class="n">orderid</span>
<span class="k">FROM</span> <span class="k">user</span> <span class="n">u</span>
<span class="k">JOIN</span> <span class="k">order</span> <span class="n">o</span> <span class="k">ON</span> <span class="n">u</span><span class="p">.</span><span class="n">uid</span> <span class="o">=</span> <span class="n">o</span><span class="p">.</span><span class="n">uid</span><span class="p">;</span>
</code></pre></div>
<p>Hive是利用hadoop的Map/Reduce计算框架执行上述查询的呢？？</p>

<p>Hive会将出现在连接条件ON之后的所有字段作为Map输出的key，将所需的字段作为value，构建(key, value)，同时为每张表打上不同的标记tag，输出到Reduce端。在Reduce端，根据tag区分参与连接的表，实现连接操作。</p>

<p>我们使用下图来模拟这个过程：</p>

<p><img src="http://tech.meituan.com/img/hive/join.png" alt="join原理图"></p>

<p>在Map端分别扫描user和order的两张表。对于user表，在连接条件ON之后的字段为uid，所以以uid作为Map输出的key，在SELECT语句中还需要name字段，所以name字段作为value的一部分，同时为user表赋予标记tag=1，这样处理user表的mapper地输出形式为：(uid, &quot;1&quot; + name)。类似的，处理order表的mapper地输出形式为：(uid, &quot;2&quot; + orderid)，注意，order表的标记为2。</p>

<p>具有相同uid的地(key, value)字段在reduce端“集合”，根据value中tag字段区分来自不同表的数据，使用两层循环完成连接操作。</p>

<p>上面就是将Join操作转换为Map/Reduce作业的基本原理： 在map端扫描表，在reduce端完成连接操作。</p>

<h1 id="2-hive中的各种join">2. Hive中的各种Join</h1>

<p>我们使用例子讲述各种Join的区别。假设user和order两张表的数据变为：</p>

<p>user表：</p>

<table><thead>
<tr>
<th>sid</th>
<th>name</th>
</tr>
</thead><tbody>
<tr>
<td>1</td>
<td>apple</td>
</tr>
<tr>
<td>2</td>
<td>orange</td>
</tr>
<tr>
<td>3</td>
<td>banana</td>
</tr>
</tbody></table>

<p>order表：</p>

<table><thead>
<tr>
<th>uid</th>
<th>orderid</th>
</tr>
</thead><tbody>
<tr>
<td>1</td>
<td>1001</td>
</tr>
<tr>
<td>1</td>
<td>1002</td>
</tr>
<tr>
<td>2</td>
<td>1003</td>
</tr>
<tr>
<td>4</td>
<td>2001</td>
</tr>
</tbody></table>

<blockquote>
<p>“不要考虑例子在现实中的意义，这里这是为了演示各种JOIN的区别”</p>
</blockquote>

<h2 id="inner-join">INNER JOIN</h2>

<h2 id="2-1-left-outer-join">2.1 LEFT OUTER JOIN</h2>

<h2 id="outer-join">OUTER JOIN</h2>

<h2 id="2-2-right-outer-join">2.2 RIGHT OUTER JOIN</h2>

<h2 id="2-3-full-outer-join">2.3 FULL OUTER JOIN</h2>

<h2 id="2-4-left-smei-join">2.4 LEFT SMEI JOIN</h2>

<h1 id="3-执行计划总结">3. 执行计划总结</h1>

<h2 id="参考资料">参考资料</h2>

<p>[1]. <a href="http://tech.meituan.com/hive-sql-to-mapreduce.html">http://tech.meituan.com/hive-sql-to-mapreduce.html</a></p>

                </div>


                <div id="pay" style="text-align:center;">
                  ----EOF-----
                  <br>
                  
                </div>

                <p class="meta">
                	
                      Categories:
                	    
                    	<a class="btn btn-default btn-xs" href="/categories.html#hive">hive</a>
                    
                	

                	
                      Tags:
                	    
                    	<a class="btn btn-default btn-xs" href="/tags.html#hive join">hive join</a>
                    
                	
                </p>
          	</article>

          	<ul class="pager">
          	  
          	  <li class="previous"><a class="btn btn-xs" href="/2015/10/16/olap" title="OLAP">&larr; Prev</a></li>
          	  
          	  
          	  <li class="next"><a class="btn btn-xs" href="/2015/10/26/Hive%E4%B9%8Bmac%E7%8E%AF%E5%A2%83%E4%B8%AD%E7%9A%84Java%E8%B7%AF%E5%BE%84%E9%97%AE%E9%A2%98" title="Hive之mac环境中的Java路径问题">Next &rarr;</a></li>
          	  
          	</ul>

            <!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="/2015/10/25/Hive之JOIN原理、JOIN优化与执行计划" data-title="Hive:JOIN原理、JOIN优化与执行计划" data-url="/2015/10/25/Hive%E4%B9%8BJOIN%E5%8E%9F%E7%90%86%E3%80%81JOIN%E4%BC%98%E5%8C%96%E4%B8%8E%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92"></div>
<!-- 多说评论框 end -->


          </div>

        </div>
      </div>

      <footer class="footer text-center">
        <p>&copy; 2009-2015 <a href="/" target="_blank" title="">小z</a> CC BY-NC-SA 3.0. <a href="https://github.com/javachen/javachen-blog-theme" target="_blank" title="https://github.com/javachen/javachen-blog-theme">Theme</a> build with <a href="//jekyllrb.com/" target="_blank" title="Transform your plain text into static websites and blogs.">Jekyll</a>.
      	            
            
        </p>
        <div id="toTop" style="display: block;">  <a href="#">▲</a><a href="#footer">▼</a>  </div>
      </footer>

      <script type="text/javascript" src="/static/js/jquery.min.js"></script>
      <script type="text/javascript" src="/static/js/bootstrap.min.js"></script>
      <script type="text/javascript" src="/static/js/core.js"></script>
      
      <!-- duoshuo Begin -->
      <script type="text/javascript">
        var duoshuoQuery = {short_name:"datavalley"};
        (function() {
          var ds = document.createElement('script');
          ds.type = 'text/javascript';ds.async = true;
          ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
          ds.charset = 'UTF-8';
          (document.getElementsByTagName('head')[0] 
           || document.getElementsByTagName('body')[0]).appendChild(ds);
        })();
      </script>
      <!-- duoshuo End -->
      


    </div>
  </body>
</html>
