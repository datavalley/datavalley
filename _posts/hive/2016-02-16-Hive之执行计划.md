---
layout: post
title:  "Hive之执行计划"
keywords: "hive"
description: "Hive之执行计划"
category: Hive
tags: [hive COUNT DISTINCT]
---

```sql
EXPLAIN
SELECT
  datekey,
  count(*)
FROM topic.deal_date
WHERE datekey = 20160201
GROUP BY datekey
;
```

上述SQL的执行计划为：

```sql
STAGE DEPENDENCIES:   -- 上述SQL的执行阶段信息，在这里，Stage-1对应一个mapreduce job
  Stage-1 is a root stage
  Stage-0 is a root stage

STAGE PLANS:
  Stage: Stage-1
    Map Reduce
      Map Operator Tree:   -- map阶段
          TableScan
            alias: deal_date    -- 表名
            Statistics: Num rows: 3010296064 Data size: 24082368512 Basic stats: COMPLETE Column stats: NONE   -- 统计信息，包括数据行数，以及数据大小
            Filter Operator
              predicate: (datekey = 20160201) (type: boolean)  -- 使用where条件进行过滤
              Statistics: Num rows: 1505148032 Data size: 12041184256 Basic stats: COMPLETE Column stats: NONE
              Select Operator
                expressions: datekey (type: bigint)  -- select的列
                outputColumnNames: datekey
                Statistics: Num rows: 1505148032 Data size: 12041184256 Basic stats: COMPLETE Column stats: NONE
                Group By Operator  -- map阶段进行group by操作，减少shuffle数据量
                  aggregations: count()   
                  keys: datekey (type: bigint)
                  mode: hash
                  outputColumnNames: _col0, _col1   -- 输出datekey和count()两列
                  Statistics: Num rows: 1505148032 Data size: 12041184256 Basic stats: COMPLETE Column stats: NONE
                  Reduce Output Operator   -- 这里描述map的输出，也即reduce的输入信息。
                    key expressions: _col0 (type: bigint)    -- map输出的key，在这里，_col0对应datekey
                    sort order: +   -- 排序，+表示按一个字段进行排序，++表示按照两个字段排序，依次类推
                    Map-reduce partition columns: _col0 (type: bigint)   -- map输出的partition信息，即根据_col0（datekey）进行分发
                    Statistics: Num rows: 1505148032 Data size: 12041184256 Basic stats: COMPLETE Column stats: NONE
                    value expressions: _col1 (type: bigint)   -- map输出的value字段，即count()值
      Reduce Operator Tree:  -- reduce阶段
        Group By Operator  -- reduce阶段进行group by操作
          aggregations: count(VALUE._col0)   
          keys: KEY._col0 (type: bigint)
          mode: mergepartial
          outputColumnNames: _col0, _col1
          Statistics: Num rows: 752574016 Data size: 6020592128 Basic stats: COMPLETE Column stats: NONE
          Select Operator
            expressions: _col0 (type: bigint), _col1 (type: bigint)
            outputColumnNames: _col0, _col1
            Statistics: Num rows: 752574016 Data size: 6020592128 Basic stats: COMPLETE Column stats: NONE
            File Output Operator
              compressed: false
              Statistics: Num rows: 752574016 Data size: 6020592128 Basic stats: COMPLETE Column stats: NONE
              table:
                  input format: org.apache.hadoop.mapred.TextInputFormat
                  output format: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
                  serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe

  Stage: Stage-0
    Fetch Operator
      limit: -1
 ```

## 参考链接

[Hive 执行计划](http://www.cnblogs.com/halentest/p/3291076.html)